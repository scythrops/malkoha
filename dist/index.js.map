{"version":3,"sources":["../lib/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["const Call = require('call');\nconst Hoek = require('hoek');\nconst Joi = require('joi');\n\nconst Handler = Joi.alternatives([\n  Joi.func(),\n  Joi.object({\n    statusCode: Joi.number().positive().integer().min(200).default(200),\n    headers: Joi.object(),\n    payload: Joi.required()\n  }),\n  Joi.object({\n    isBoom: true\n  }).unknown()\n]);\n\nconst route = Joi.alternatives([\n    Joi.object({\n      method: Joi.string().regex(/^[a-zA-Z0-9!#\\$%&'\\*\\+\\-\\.^_`\\|~]+$/).lowercase().default('get'),\n      path: Joi.string().required(),\n      handler: Handler,\n      vhost: Joi.array().items(Joi.string().hostname()).min(1).single().default(['*']),\n      filter: Joi.func().optional(),\n    }),\n    Joi.object({\n      method: Joi.string().regex(/^[a-zA-Z0-9!#\\$%&'\\*\\+\\-\\.^_`\\|~]+$/).lowercase().default('get'),\n      path: Joi.string().required(),\n      config: Joi.object({\n          handler: Handler\n        }).unknown(),\n      vhost: Joi.array().items(Joi.string().hostname()).min(1).single().default(['*']),\n      filter: Joi.func().optional(),\n    }),\n  ]);\n\nconst simplifyPath = (str)=>{\n  return str.replace(/{[^}]+}/gi, ()=>'{token}');\n};\n\nclass Malkoha{\n  constructor(server){\n    this.server = server;\n    this._routes = [];\n\n    Hoek.assert(this.server.connections.length, 'Cannot malkoha a server without any connections');\n  }\n\n  getRoute(route){\n    const index = this.indexOf(route);\n    return index>-1?this._routes[index]:false;\n  }\n\n  indexOf(route){\n    const {\n      method,\n      path\n    } = route;\n    const pathSearchable = simplifyPath(path);\n    return this._routes.findIndex((route)=>{\n      return (route.method.toUpperCase() === method.toUpperCase()) && (simplifyPath(route.path) === pathSearchable);\n    });\n  }\n\n  route(options){\n    const routes = Array.isArray(options)?options:[options];\n    const connections = this.server.connections;\n    routes.forEach((config)=>{\n      const settings = Joi.attempt(Hoek.clone(config), route);\n      let cfg = this.getRoute(settings);\n      if(cfg){\n        cfg.handler = settings.handler || false;\n        cfg.config = settings.config;\n        cfg.tags = settings.tags;\n        cfg.filter = settings.filter;\n        cfg.validate = settings.validate;\n        cfg.path = settings.path;\n        return;\n      }\n\n      this._routes.push(settings);\n      connections.forEach((connection)=>{\n        if(connection.plugins.malkoha){\n          const router = connection.plugins.malkoha._router;\n\n          settings.vhost.forEach((vhost)=>{\n            router.add({ method: settings.method, path: settings.path, vhost: vhost }, settings);\n          });\n        }\n      });\n    });\n  }\n\n  delete(options){\n    const routes = Array.isArray(options)?options:[options];\n    routes.forEach((route)=>{\n      const index = this.indexOf(route);\n      if(index > -1){\n        this._routes[index].handler = false;\n      }\n    });\n  }\n}\n\nconst onRequest = (req, reply)=>{\n  const router = req.connection.plugins.malkoha._router;\n  const match = router.route(req.method, req.path, req.info.hostname);\n  if(match.isBoom){\n    return reply.continue();\n  }\n\n  const handler = match.route.handler || (match.route.config||{}).handler;\n  if(!handler){\n    return reply.continue();\n  }\n\n  const respond = ()=>{\n    if(typeof(handler) === 'function'){\n      return handler(Object.assign({}, req, match), reply);\n    }\n\n    if(handler.isBoom){\n      return reply(handler);\n    }\n\n    return reply(handler.payload).code(handler.statusCode);\n  };\n\n  if(!match.route.filter){\n    return respond();\n  }\n\n  match.route.filter(req, (isMatch)=>{\n    if(isMatch){\n      return respond();\n    }\n    return reply.continue();\n  });\n};\n\nconst MalkohaPlugin={\n  register(server, options, next){\n    server.connections.forEach((connection)=>{\n      connection.plugins.malkoha = {\n          _router: new Call.Router(connection.settings.router),\n        };\n    });\n\n    const m = new Malkoha(server);\n    server.decorate('server', 'malkoha', m);\n    server.ext('onRequest', onRequest);\n\n    return next();\n  },\n};\n\nMalkohaPlugin.register.attributes = {\n  pkg: require('../package.json')\n};\n\nmodule.exports = {\n  Malkoha: MalkohaPlugin,\n};\n"]}